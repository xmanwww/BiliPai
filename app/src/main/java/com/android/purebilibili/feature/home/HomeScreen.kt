// æ–‡ä»¶è·¯å¾„: feature/home/HomeScreen.kt
package com.android.purebilibili.feature.home

import android.annotation.SuppressLint
import android.content.Context
import androidx.compose.animation.*
import androidx.compose.animation.core.tween
import androidx.compose.foundation.gestures.detectHorizontalDragGestures
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.grid.*
import androidx.compose.foundation.lazy.staggeredgrid.*  // ğŸŒŠ ç€‘å¸ƒæµå¸ƒå±€
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.*
import androidx.compose.material3.pulltorefresh.PullToRefreshBox
import androidx.compose.material3.pulltorefresh.rememberPullToRefreshState
import androidx.compose.runtime.*
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.runtime.snapshotFlow
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.zIndex
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.input.nestedscroll.nestedScroll
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalDensity
import androidx.compose.ui.graphics.luminance  // ğŸ”¥ çŠ¶æ€æ äº®åº¦è®¡ç®—
import androidx.compose.ui.unit.dp
import androidx.lifecycle.viewmodel.compose.viewModel
import com.android.purebilibili.core.theme.BiliPink
import com.android.purebilibili.feature.settings.GITHUB_URL
import com.android.purebilibili.core.store.SettingsManager // ğŸ”¥ å¼•å…¥ SettingsManager
// ğŸ”¥ ä» components åŒ…å¯¼å…¥æ‹†åˆ†åçš„ç»„ä»¶
import com.android.purebilibili.feature.home.components.BottomNavItem
import com.android.purebilibili.feature.home.components.FluidHomeTopBar
import com.android.purebilibili.feature.home.components.FrostedBottomBar
import com.android.purebilibili.feature.home.components.CategoryTabRow
import com.android.purebilibili.feature.home.components.iOSHomeHeader  // ğŸ iOS å¤§æ ‡é¢˜å¤´éƒ¨
import com.android.purebilibili.feature.home.components.iOSRefreshIndicator  // ğŸ iOS ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨
// ğŸ”¥ ä» cards å­åŒ…å¯¼å…¥å¡ç‰‡ç»„ä»¶
import com.android.purebilibili.feature.home.components.cards.ElegantVideoCard
import com.android.purebilibili.feature.home.components.cards.LiveRoomCard
import com.android.purebilibili.feature.home.components.cards.StoryVideoCard   // ğŸ¬ æ•…äº‹å¡ç‰‡
import com.android.purebilibili.feature.home.components.cards.GlassVideoCard   // ğŸ ç»ç’ƒæ‹Ÿæ€
import com.android.purebilibili.core.ui.LoadingAnimation
import com.android.purebilibili.core.ui.VideoCardSkeleton
import com.android.purebilibili.core.ui.ErrorState as ModernErrorState
import dev.chrisbanes.haze.HazeState
import dev.chrisbanes.haze.haze
import com.android.purebilibili.core.ui.shimmer
import com.android.purebilibili.core.ui.LocalSharedTransitionScope  // ğŸ”¥ å…±äº«è¿‡æ¸¡
import io.github.alexzhirkevich.cupertino.CupertinoActivityIndicator
import coil.imageLoader
import kotlinx.coroutines.launch
import kotlinx.coroutines.flow.distinctUntilChanged  // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šé˜²æ­¢é‡å¤è§¦å‘
import androidx.compose.animation.ExperimentalSharedTransitionApi  // ğŸ”¥ å…±äº«è¿‡æ¸¡å®éªŒAPI

@SuppressLint("UnusedMaterial3ScaffoldPaddingParameter")
@OptIn(ExperimentalMaterial3Api::class, ExperimentalSharedTransitionApi::class)
@Composable
fun HomeScreen(
    viewModel: HomeViewModel = viewModel(),
    onVideoClick: (String, Long, String) -> Unit,
    onAvatarClick: () -> Unit,
    onProfileClick: () -> Unit,
    onSettingsClick: () -> Unit,
    onSearchClick: () -> Unit,
    // ğŸ”¥ æ–°å¢ï¼šåŠ¨æ€é¡µé¢å›è°ƒ
    onDynamicClick: () -> Unit = {},
    // ğŸ”¥ æ–°å¢ï¼šå†å²è®°å½•å›è°ƒ
    onHistoryClick: () -> Unit = {},
    // ğŸ”¥ æ–°å¢ï¼šåˆ†åŒºå›è°ƒ
    onPartitionClick: () -> Unit = {},
    // ğŸ”¥ æ–°å¢ï¼šç›´æ’­ç‚¹å‡»å›è°ƒ
    onLiveClick: (Long, String, String) -> Unit = { _, _, _ -> },  // roomId, title, uname
    // ğŸ”¥ğŸ”¥ [ä¿®å¤] ç•ªå‰§/å½±è§†å›è°ƒï¼Œæ¥å—ç±»å‹å‚æ•° (1=ç•ªå‰§ 2=ç”µå½± ç­‰)
    onBangumiClick: (Int) -> Unit = {},
    // ğŸ”¥ æ–°å¢ï¼šåˆ†ç±»ç‚¹å‡»å›è°ƒï¼ˆç”¨äºæ¸¸æˆã€çŸ¥è¯†ã€ç§‘æŠ€ç­‰åˆ†ç±»ï¼Œä¼ å…¥ tid å’Œ nameï¼‰
    onCategoryClick: (Int, String) -> Unit = { _, _ -> }
) {
    val state by viewModel.uiState.collectAsState()
    val isRefreshing by viewModel.isRefreshing.collectAsState()
    val pullRefreshState = rememberPullToRefreshState()
    val context = LocalContext.current
    val gridState = rememberLazyGridState()
    val staggeredGridState = rememberLazyStaggeredGridState()  // ğŸŒŠ ç€‘å¸ƒæµçŠ¶æ€
    val hazeState = remember { HazeState() }
    val coroutineScope = rememberCoroutineScope()  // ğŸ ç”¨äºåŒå‡»å›é¡¶åŠ¨ç”»
    
    // ğŸ”Œ [æ–°å¢] JSON æ’ä»¶è¿‡æ»¤æç¤º
    val snackbarHostState = remember { SnackbarHostState() }
    val lastFilteredCount by com.android.purebilibili.core.plugin.json.JsonPluginManager.lastFilteredCount.collectAsState()
    
    // ğŸ”Œ å½“æœ‰è§†é¢‘è¢«è¿‡æ»¤æ—¶æ˜¾ç¤ºæç¤º
    LaunchedEffect(lastFilteredCount) {
        if (lastFilteredCount > 0) {
            snackbarHostState.showSnackbar(
                message = "ğŸ”Œ å·²è¿‡æ»¤ $lastFilteredCount ä¸ªè§†é¢‘",
                duration = SnackbarDuration.Short
            )
        }
    }
    
    // ğŸ”¥ğŸ”¥ [ä¿®å¤] ç¡®ä¿é¦–é¡µæ˜¾ç¤ºæ—¶ WindowInsets é…ç½®æ­£ç¡®ï¼Œé˜²æ­¢ä»è§†é¢‘é¡µè¿”å›æ—¶å¸ƒå±€è·³åŠ¨
    val view = androidx.compose.ui.platform.LocalView.current
    SideEffect {
        val window = (view.context as? android.app.Activity)?.window ?: return@SideEffect
        // ä¿æŒè¾¹åˆ°è¾¹æ˜¾ç¤ºï¼ˆä¸ VideoDetailScreen ä¸€è‡´ï¼‰
        androidx.core.view.WindowCompat.setDecorFitsSystemWindows(window, false)
    }

    // ï¿½ï¿½ [æ€§èƒ½ä¼˜åŒ–] åˆå¹¶é¦–é¡µè®¾ç½®ä¸ºå•ä¸€ Flowï¼Œå‡å°‘ 6 ä¸ª collectAsState â†’ 1 ä¸ª
    val homeSettings by SettingsManager.getHomeSettings(context).collectAsState(
        initial = com.android.purebilibili.core.store.HomeSettings()
    )
    
    // è§£æ„è®¾ç½®å€¼ï¼ˆé¿å…æ¯æ¬¡è®¿é—®éƒ½è§¦å‘é‡ç»„ï¼‰
    val displayMode = homeSettings.displayMode
    val isBottomBarFloating = homeSettings.isBottomBarFloating
    val bottomBarLabelMode = homeSettings.bottomBarLabelMode
    val isHeaderBlurEnabled = homeSettings.isHeaderBlurEnabled
    val isBottomBarBlurEnabled = homeSettings.isBottomBarBlurEnabled
    val crashTrackingConsentShown = homeSettings.crashTrackingConsentShown
    val cardAnimationEnabled = homeSettings.cardAnimationEnabled      // ğŸ”¥ å¡ç‰‡è¿›åœºåŠ¨ç”»å¼€å…³
    val cardTransitionEnabled = homeSettings.cardTransitionEnabled    // ğŸ”¥ å¡ç‰‡è¿‡æ¸¡åŠ¨ç”»å¼€å…³
    
    // ğŸ”¥ğŸ”¥ [ä¿®å¤] æ ¹æ®å±•ç¤ºæ¨¡å¼åŠ¨æ€è®¾ç½®ç½‘æ ¼åˆ—æ•°
    // æ•…äº‹å¡ç‰‡éœ€è¦å•åˆ—å…¨å®½ï¼Œç½‘æ ¼å’Œç»ç’ƒä½¿ç”¨åŒåˆ—
    val gridColumns = if (displayMode == 1) 1 else 2

    // ğŸ”¥ğŸ”¥ [ä¿®å¤] æ¢å¤çŠ¶æ€æ æ ·å¼ï¼šç¡®ä¿ä»è§†é¢‘è¯¦æƒ…é¡µè¿”å›åçŠ¶æ€æ æ­£ç¡®
    // å½“ä½¿ç”¨æ»‘åŠ¨åŠ¨ç”»æ—¶ï¼ŒTheme.kt çš„ SideEffect å¯èƒ½ä¸ä¼šé‡æ–°æ‰§è¡Œ
    val backgroundColor = MaterialTheme.colorScheme.background
    val isLightBackground = remember(backgroundColor) { backgroundColor.luminance() > 0.5f }
    
    if (!view.isInEditMode) {
        SideEffect {
            val window = (context as? android.app.Activity)?.window ?: return@SideEffect
            val insetsController = androidx.core.view.WindowCompat.getInsetsController(window, view)
            // ğŸ”¥ æ ¹æ®èƒŒæ™¯äº®åº¦è®¾ç½®çŠ¶æ€æ å›¾æ ‡é¢œè‰²
            insetsController.isAppearanceLightStatusBars = isLightBackground
            // ğŸ”¥ ç¡®ä¿çŠ¶æ€æ å¯è§ä¸”é€æ˜
            insetsController.show(androidx.core.view.WindowInsetsCompat.Type.statusBars())
            window.statusBarColor = android.graphics.Color.TRANSPARENT
        }
    }

    val density = LocalDensity.current
    val navBarHeight = WindowInsets.navigationBars.getBottom(density).let { with(density) { it.toDp() } }
    
    // ğŸ”¥ åŠ¨æ€è®¡ç®—åº•éƒ¨é¿è®©é«˜åº¦
    val bottomBarHeight = if (isBottomBarFloating) {
        84.dp + navBarHeight  // 72dp(æ é«˜åº¦) + 12dp(åº•éƒ¨è¾¹è·)
    } else {
        64.dp + navBarHeight  // 64dp(Dockedæ¨¡å¼)
    }

    val prefs = remember { context.getSharedPreferences("app_prefs", Context.MODE_PRIVATE) }
    
    // ğŸ”¥ å½“å‰é€‰ä¸­çš„å¯¼èˆªé¡¹
    var currentNavItem by remember { mutableStateOf(BottomNavItem.HOME) }
    
    // ğŸ”¥ğŸ”¥ [æ–°å¢] åº•æ æ˜¾ç¤ºæ¨¡å¼è®¾ç½®
    val bottomBarVisibilityMode by SettingsManager.getBottomBarVisibilityMode(context).collectAsState(
        initial = SettingsManager.BottomBarVisibilityMode.ALWAYS_VISIBLE
    )
    
    // ğŸ”¥ğŸ”¥ [æ–°å¢] åº•æ å¯è§æ€§çŠ¶æ€ï¼ˆæ ¹æ®æ¨¡å¼åˆå§‹åŒ–ï¼‰
    var bottomBarVisible by remember { mutableStateOf(true) }
    
    // ğŸ”¥ğŸ”¥ [ä¿®å¤] è·Ÿè¸ªæ˜¯å¦æ­£åœ¨å¯¼èˆªåˆ°/ä»è§†é¢‘é¡µ - å¿…é¡»åœ¨ LaunchedEffect ä¹‹å‰å£°æ˜
    var isVideoNavigating by remember { mutableStateOf(false) }
    
    // ğŸ”¥ğŸ”¥ [æ–°å¢] æ»šåŠ¨æ–¹å‘æ£€æµ‹çŠ¶æ€ï¼ˆç”¨äºä¸Šæ»‘éšè—æ¨¡å¼ï¼‰
    var lastScrollOffset by remember { mutableIntStateOf(0) }
    var lastFirstVisibleItem by remember { mutableIntStateOf(0) }
    
    // ğŸ”¥ğŸ”¥ [æ–°å¢] æ»šåŠ¨æ–¹å‘æ£€æµ‹é€»è¾‘
    LaunchedEffect(gridState, bottomBarVisibilityMode) {
        if (bottomBarVisibilityMode != SettingsManager.BottomBarVisibilityMode.SCROLL_HIDE) {
            // éæ»šåŠ¨éšè—æ¨¡å¼æ—¶ï¼Œæ ¹æ®è®¾ç½®å†³å®šåº•æ å¯è§æ€§
            bottomBarVisible = bottomBarVisibilityMode == SettingsManager.BottomBarVisibilityMode.ALWAYS_VISIBLE
            return@LaunchedEffect
        }
        
        // ä¸Šæ»‘éšè—æ¨¡å¼ï¼šç›‘å¬æ»šåŠ¨æ–¹å‘
        snapshotFlow {
            Pair(gridState.firstVisibleItemIndex, gridState.firstVisibleItemScrollOffset)
        }
        .distinctUntilChanged()
        .collect { (firstVisibleItem, scrollOffset) ->
            // è§†é¢‘å¯¼èˆªæœŸé—´ä¸å¤„ç†æ»šåŠ¨éšè—
            if (isVideoNavigating) return@collect
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨æ—¶å§‹ç»ˆæ˜¾ç¤º
            if (firstVisibleItem == 0 && scrollOffset < 100) {
                bottomBarVisible = true
            } else {
                // è®¡ç®—æ»šåŠ¨æ–¹å‘
                val isScrollingDown = when {
                    firstVisibleItem > lastFirstVisibleItem -> true
                    firstVisibleItem < lastFirstVisibleItem -> false
                    else -> scrollOffset > lastScrollOffset + 30 // é˜ˆå€¼30px
                }
                val isScrollingUp = when {
                    firstVisibleItem < lastFirstVisibleItem -> true
                    firstVisibleItem > lastFirstVisibleItem -> false
                    else -> scrollOffset < lastScrollOffset - 30
                }
                
                if (isScrollingDown) bottomBarVisible = false
                else if (isScrollingUp) bottomBarVisible = true
            }
            
            lastFirstVisibleItem = firstVisibleItem
            lastScrollOffset = scrollOffset
        }
    }
    
    // ğŸ”¥ğŸ”¥ [ä¿®å¤] ç”¨äºå–æ¶ˆå»¶è¿Ÿåç¨‹çš„ Job å¼•ç”¨
    var bottomBarRestoreJob by remember { mutableStateOf<kotlinx.coroutines.Job?>(null) }
    
    // ğŸ”¥ğŸ”¥ åŒ…è£… onVideoClickï¼šç‚¹å‡»è§†é¢‘æ—¶å…ˆéšè—åº•æ å†å¯¼èˆª
    val wrappedOnVideoClick: (String, Long, String) -> Unit = remember(onVideoClick) {
        { bvid, cid, cover ->
            // ğŸ”¥ å–æ¶ˆä¹‹å‰çš„æ¢å¤åç¨‹ï¼Œé˜²æ­¢ç«æ€æ¡ä»¶
            bottomBarRestoreJob?.cancel()
            bottomBarRestoreJob = null
            
            bottomBarVisible = false  // ğŸ”¥ è§¦å‘åº•æ ä¸‹æ»‘åŠ¨ç”»
            isVideoNavigating = true  // ğŸ”¥ æ ‡è®°æ­£åœ¨å¯¼èˆªåˆ°è§†é¢‘
            onVideoClick(bvid, cid, cover)
        }
    }
    
    // ğŸ”¥ğŸ”¥ [ä¿®å¤] ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æ§åˆ¶åº•æ å¯è§æ€§
    // ON_START: æ¢å¤åº•æ ï¼ˆä»…åœ¨ä»è§†é¢‘é¡µè¿”å›æ—¶ï¼‰
    // ON_STOP: éšè—åº•æ ï¼ˆå¯¼èˆªåˆ°å…¶ä»–é¡µé¢æ—¶ï¼Œé¿å…å½±å“å¯¼èˆªæ åŒºåŸŸï¼‰
    val lifecycleOwner = androidx.compose.ui.platform.LocalLifecycleOwner.current
    DisposableEffect(lifecycleOwner) {
        val observer = androidx.lifecycle.LifecycleEventObserver { _, event ->
            when (event) {
                androidx.lifecycle.Lifecycle.Event.ON_START -> {
                    // ğŸ”¥ğŸ”¥ å…³é”®ä¿®å¤ï¼šåªåœ¨åº•æ å½“å‰éšè—æ—¶æ‰æ¢å¤å¯è§
                    if (!bottomBarVisible && isVideoNavigating) {
                        // ğŸ”¥ğŸ”¥ [åŒæ­¥åŠ¨ç”»] å»¶è¿Ÿåå†æ˜¾ç¤ºåº•æ ï¼Œè®©è¿›å…¥åŠ¨ç”»ä¸å¡ç‰‡è¿”å›åŠ¨ç”»åŒæ­¥
                        bottomBarRestoreJob = kotlinx.coroutines.MainScope().launch {
                            kotlinx.coroutines.delay(100)  // ç­‰å¾…è¿”å›åŠ¨ç”»å¼€å§‹
                            bottomBarVisible = true
                            // å»¶è¿Ÿé‡ç½®å¯¼èˆªçŠ¶æ€ï¼Œç¡®ä¿è¿›å…¥åŠ¨ç”»å®Œæˆ
                            kotlinx.coroutines.delay(400)
                            isVideoNavigating = false
                        }
                    } else if (!bottomBarVisible && !isVideoNavigating) {
                        // ğŸ”¥ğŸ”¥ [æ–°å¢] ä»è®¾ç½®ç­‰éè§†é¢‘é¡µé¢è¿”å›æ—¶ï¼Œç«‹å³æ˜¾ç¤ºåº•æ ï¼ˆæ— å»¶è¿Ÿï¼‰
                        bottomBarVisible = true
                    }
                }
                androidx.lifecycle.Lifecycle.Event.ON_STOP -> {
                    // ğŸ”¥ğŸ”¥ [æ–°å¢] å¯¼èˆªç¦»å¼€é¦–é¡µæ—¶éšè—åº•æ ï¼Œé¿å…å½±å“å…¶ä»–é¡µé¢çš„å¯¼èˆªæ åŒºåŸŸ
                    bottomBarRestoreJob?.cancel()
                    bottomBarRestoreJob = null
                    bottomBarVisible = false
                }
                else -> { /* å…¶ä»–äº‹ä»¶ä¸å¤„ç† */ }
            }
        }
        lifecycleOwner.lifecycle.addObserver(observer)
        onDispose {
            bottomBarRestoreJob?.cancel()
            lifecycleOwner.lifecycle.removeObserver(observer)
        }
    }
    
    // ğŸ”¥ğŸ”¥ [ä¿®å¤] ä½¿ç”¨ ViewModel ä¸­çš„æ ‡ç­¾é¡µæ˜¾ç¤ºç´¢å¼•ï¼ˆè·¨å¯¼èˆªä¿æŒï¼‰
    // å½“ç”¨æˆ·æ»‘åŠ¨åˆ°ç‰¹æ®Šåˆ†ç±»æ—¶ï¼Œæ ‡ç­¾é¡µä½ç½®æ›´æ–°ï¼Œä½†å†…å®¹åˆ†ç±»ä¿æŒä¸å˜
    val displayedTabIndex = state.displayedTabIndex
    
    // ğŸ”¥ğŸ”¥ [ä¿®å¤] ä½¿ç”¨ rememberSaveable è®°ä½æœ¬æ¬¡ä¼šè¯ä¸­æ˜¯å¦å·²å¤„ç†è¿‡å¼¹çª—ï¼ˆé˜²æ­¢å¯¼èˆªåé‡æ–°æ˜¾ç¤ºï¼‰
    var consentDialogHandled by rememberSaveable { mutableStateOf(false) }
    var showConsentDialog by remember { mutableStateOf(false) }
    
    // ğŸ”¥ğŸ”¥ æ£€æŸ¥æ¬¢è¿å¼¹çª—æ˜¯å¦å·²æ˜¾ç¤ºè¿‡ï¼ˆç¡®ä¿å¼¹çª—é¡ºåºæ˜¾ç¤ºï¼Œä¸ä¼šåŒæ—¶å‡ºç°ï¼‰
    val welcomePrefs = remember { context.getSharedPreferences("app_welcome", Context.MODE_PRIVATE) }
    val welcomeAlreadyShown = welcomePrefs.getBoolean("first_launch_shown", false)
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå¼¹çª—ï¼ˆæ¬¢è¿å¼¹çª—å·²æ˜¾ç¤ºè¿‡ ä¸” åŒæ„å¼¹çª—å°šæœªæ˜¾ç¤ºè¿‡ ä¸” æœ¬æ¬¡ä¼šè¯æœªå¤„ç†è¿‡ï¼‰
    LaunchedEffect(crashTrackingConsentShown) {
        if (welcomeAlreadyShown && !crashTrackingConsentShown && !consentDialogHandled) {
            showConsentDialog = true
        }
    }
    
    // æ˜¾ç¤ºå¼¹çª—
    if (showConsentDialog) {
        com.android.purebilibili.feature.home.components.CrashTrackingConsentDialog(
            onDismiss = { 
                showConsentDialog = false
                consentDialogHandled = true  // æ ‡è®°ä¸ºå·²å¤„ç†
            }
        )
    }
    
    // ğŸ è®¡ç®—æ»šåŠ¨åç§»é‡ç”¨äºå¤´éƒ¨åŠ¨ç”» - ğŸš€ ä¼˜åŒ–ï¼šé‡åŒ–å‡å°‘é‡ç»„
    val scrollOffset by remember {
        derivedStateOf {
            val firstVisibleItem = gridState.firstVisibleItemIndex
            if (firstVisibleItem == 0) {
                // ğŸš€ é‡åŒ–åˆ° 50px å•ä½ï¼Œå‡å°‘é‡ç»„é¢‘ç‡
                val raw = gridState.firstVisibleItemScrollOffset
                (raw / 50) * 50f
            } else 1000f
        }
    }
    
    // ğŸ æ»šåŠ¨æ–¹å‘ï¼ˆç®€åŒ–ç‰ˆ - ä¸å†éœ€è¦å¤æ‚æ£€æµ‹ï¼Œå› ä¸ºæ ‡ç­¾é¡µåªåœ¨é¡¶éƒ¨æ˜¾ç¤ºï¼‰
    val isScrollingUp = true  // ä¿ç•™å‚æ•°å…¼å®¹æ€§

    val shouldLoadMore by remember {
        derivedStateOf {
            val layoutInfo = gridState.layoutInfo
            val totalItems = layoutInfo.totalItemsCount
            val lastVisibleItemIndex = layoutInfo.visibleItemsInfo.lastOrNull()?.index ?: 0
            totalItems > 0 && lastVisibleItemIndex >= totalItems - 4 && !state.isLoading && !isRefreshing
        }
    }
    LaunchedEffect(shouldLoadMore) { if (shouldLoadMore) viewModel.loadMore() }
    
    // ğŸš€ğŸš€ [æ€§èƒ½ä¼˜åŒ–] å›¾ç‰‡é¢„åŠ è½½ - æå‰åŠ è½½å³å°†æ˜¾ç¤ºçš„è§†é¢‘å°é¢
    LaunchedEffect(gridState) {
        snapshotFlow { gridState.layoutInfo.visibleItemsInfo.lastOrNull()?.index ?: 0 }
            .distinctUntilChanged()  // ğŸš€ åªåœ¨ç´¢å¼•å˜åŒ–æ—¶è§¦å‘
            .collect { lastVisibleIndex ->
                val videos = state.videos
                val preloadStart = (lastVisibleIndex + 1).coerceAtMost(videos.size)
                val preloadEnd = (lastVisibleIndex + 6).coerceAtMost(videos.size)  // ğŸš€ å‡å°‘é¢„åŠ è½½æ•°é‡
                
                if (preloadStart < preloadEnd) {
                    for (i in preloadStart until preloadEnd) {
                        val imageUrl = videos.getOrNull(i)?.pic ?: continue
                        val request = coil.request.ImageRequest.Builder(context)
                            .data(com.android.purebilibili.core.util.FormatUtils.fixImageUrl(imageUrl))
                            .size(480, 300)  // ğŸš€ é¢„åŠ è½½ä¹Ÿä½¿ç”¨é™åˆ¶å°ºå¯¸
                            .memoryCachePolicy(coil.request.CachePolicy.ENABLED)
                            .diskCachePolicy(coil.request.CachePolicy.ENABLED)
                            .build()
                        context.imageLoader.enqueue(request)
                    }
                }
            }
    }


    // ğŸ”¥ğŸ”¥ PullToRefreshBox è‡ªåŠ¨å¤„ç†ä¸‹æ‹‰åˆ·æ–°é€»è¾‘
    
    // ğŸ”¥ğŸ”¥ [å·²ç§»é™¤] ç‰¹æ®Šåˆ†ç±»ï¼ˆANIME, MOVIEç­‰ï¼‰ä¸å†åœ¨é¦–é¡µåˆ‡æ¢ï¼Œç›´æ¥å¯¼èˆªåˆ°ç‹¬ç«‹é¡µé¢
    
    // ğŸ”¥ğŸ”¥ [ä¿®å¤] å¦‚æœå½“å‰åœ¨ç›´æ’­-å…³æ³¨åˆ†ç±»ä¸”åˆ—è¡¨ä¸ºç©ºï¼Œè¿”å›æ—¶å…ˆåˆ‡æ¢åˆ°çƒ­é—¨ï¼Œå†åˆ‡æ¢åˆ°æ¨è
    val isEmptyLiveFollowed = state.currentCategory == HomeCategory.LIVE && 
                               state.liveSubCategory == LiveSubCategory.FOLLOWED &&
                               state.liveRooms.isEmpty() && 
                               !state.isLoading
    androidx.activity.compose.BackHandler(enabled = isEmptyLiveFollowed) {
        // åˆ‡æ¢åˆ°çƒ­é—¨ç›´æ’­
        viewModel.switchLiveSubCategory(LiveSubCategory.POPULAR)
    }

    // ğŸ”¥ğŸ”¥ [ä¿®å¤] å¦‚æœå½“å‰åœ¨ç›´æ’­åˆ†ç±»ï¼ˆéå…³æ³¨ç©ºåˆ—è¡¨æƒ…å†µï¼‰ï¼Œè¿”å›æ—¶åˆ‡æ¢åˆ°æ¨è
    val isLiveCategoryNotHome = state.currentCategory == HomeCategory.LIVE && !isEmptyLiveFollowed
    androidx.activity.compose.BackHandler(enabled = isLiveCategoryNotHome) {
        viewModel.switchCategory(HomeCategory.RECOMMEND)
    }
    
    // ğŸ”¥ è®°å½•æ»‘åŠ¨æ–¹å‘ç”¨äºåŠ¨ç”» (true = å‘å³/ä¸Šä¸€ä¸ªåˆ†ç±», false = å‘å·¦/ä¸‹ä¸€ä¸ªåˆ†ç±»)
    var swipeDirection by remember { mutableStateOf(true) }
    
    // ğŸ”¥ğŸ”¥ [ä¿®å¤] ç‰¹æ®Šåˆ†ç±»åˆ—è¡¨ï¼ˆæœ‰ç‹¬ç«‹é¡µé¢ï¼Œä¸åœ¨é¦–é¡µæ˜¾ç¤ºå†…å®¹ï¼‰
    val specialCategories = listOf(
        HomeCategory.ANIME, 
        HomeCategory.MOVIE, 
        HomeCategory.GAME, 
        HomeCategory.KNOWLEDGE, 
        HomeCategory.TECH
    )
    
    // ğŸ”¥ æ°´å¹³æ»‘åŠ¨åˆ‡æ¢åˆ†ç±»çš„å›è°ƒ
    val switchToPreviousCategory: () -> Unit = remember(displayedTabIndex) {
        {
            swipeDirection = true  // å³æ»‘
            // ğŸ”¥ğŸ”¥ [ä¿®å¤] ä½¿ç”¨ ViewModel ä¸­çš„æ ‡ç­¾é¡µç´¢å¼•
            if (displayedTabIndex > 0) {
                val prevIndex = displayedTabIndex - 1
                val prevCategory = HomeCategory.entries[prevIndex]
                // æ›´æ–°æ ‡ç­¾é¡µæ˜¾ç¤ºä½ç½®ï¼ˆé€šè¿‡ ViewModelï¼‰
                viewModel.updateDisplayedTabIndex(prevIndex)
                // ğŸ”¥ğŸ”¥ [ä¿®å¤] å¯¹äºç‰¹æ®Šåˆ†ç±»ï¼Œåªå¯¼èˆªåˆ°ç‹¬ç«‹é¡µé¢ï¼›æ™®é€šåˆ†ç±»æ›´æ–°å†…å®¹
                when (prevCategory) {
                    HomeCategory.ANIME -> onBangumiClick(1)
                    HomeCategory.MOVIE -> onBangumiClick(2)
                    HomeCategory.GAME, HomeCategory.KNOWLEDGE, HomeCategory.TECH -> 
                        onCategoryClick(prevCategory.tid, prevCategory.label)
                    else -> viewModel.switchCategory(prevCategory)
                }
            }
        }
    }
    
    val switchToNextCategory: () -> Unit = remember(displayedTabIndex) {
        {
            swipeDirection = false  // å·¦æ»‘
            // ğŸ”¥ğŸ”¥ [ä¿®å¤] ä½¿ç”¨ ViewModel ä¸­çš„æ ‡ç­¾é¡µç´¢å¼•
            if (displayedTabIndex < HomeCategory.entries.size - 1) {
                val nextIndex = displayedTabIndex + 1
                val nextCategory = HomeCategory.entries[nextIndex]
                // æ›´æ–°æ ‡ç­¾é¡µæ˜¾ç¤ºä½ç½®ï¼ˆé€šè¿‡ ViewModelï¼‰
                viewModel.updateDisplayedTabIndex(nextIndex)
                // ğŸ”¥ğŸ”¥ [ä¿®å¤] å¯¹äºç‰¹æ®Šåˆ†ç±»ï¼Œåªå¯¼èˆªåˆ°ç‹¬ç«‹é¡µé¢ï¼›æ™®é€šåˆ†ç±»æ›´æ–°å†…å®¹
                when (nextCategory) {
                    HomeCategory.ANIME -> onBangumiClick(1)
                    HomeCategory.MOVIE -> onBangumiClick(2)
                    HomeCategory.GAME, HomeCategory.KNOWLEDGE, HomeCategory.TECH -> 
                        onCategoryClick(nextCategory.tid, nextCategory.label)
                    else -> viewModel.switchCategory(nextCategory)
                }
            }
        }
    }

    Scaffold(
        bottomBar = {
            // ğŸ”¥ å°è¯•è·å–å…±äº«è¿‡æ¸¡ä½œç”¨åŸŸ
            val sharedTransitionScope = LocalSharedTransitionScope.current
            
            // ğŸ”¥ğŸ”¥ [ä¿®å¤] åªåœ¨å¯¼èˆªåˆ°/ä»è§†é¢‘é¡µæ—¶ä½¿ç”¨ overlay
            // isVideoNavigating åœ¨ç‚¹å‡»è§†é¢‘æ—¶è®¾ä¸º trueï¼ŒåŠ¨ç”»å®Œæˆåé‡ç½®ä¸º false
            val bottomBarModifier = if (sharedTransitionScope != null && isVideoNavigating) {
                with(sharedTransitionScope) {
                    Modifier.renderInSharedTransitionScopeOverlay(zIndexInOverlay = 1f)
                }
            } else {
                Modifier
            }
            
            AnimatedVisibility(
                visible = bottomBarVisible,  // ğŸ”¥ å—çŠ¶æ€æ§åˆ¶
                modifier = bottomBarModifier,
                enter = slideInVertically(
                    initialOffsetY = { it },  // ä»åº•éƒ¨æ»‘å…¥
                    animationSpec = tween(350)
                ) + fadeIn(animationSpec = tween(250)),
                exit = slideOutVertically(
                    targetOffsetY = { it },   // å‘åº•éƒ¨æ»‘å‡º
                    animationSpec = tween(250)
                ) + fadeOut(animationSpec = tween(200))
            ) {
                if (isBottomBarFloating) {
                    // æ‚¬æµ®å¼åº•æ 
                    Box(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(bottom = 20.dp), // æ‚¬æµ®è·ç¦»
                        contentAlignment = Alignment.Center
                    ) {
                        FrostedBottomBar(
                            currentItem = currentNavItem,
                            onItemClick = { item ->
                                currentNavItem = item
                                when(item) {
                                    BottomNavItem.HOME -> {
                                        coroutineScope.launch { gridState.animateScrollToItem(0) }
                                    }
                                    BottomNavItem.DYNAMIC -> onDynamicClick()
                                    BottomNavItem.HISTORY -> onHistoryClick()
                                    BottomNavItem.PROFILE -> onProfileClick()
                                }
                            },
                            onHomeDoubleTap = {
                                coroutineScope.launch { gridState.animateScrollToItem(0) }
                            },
                            hazeState = if (isBottomBarBlurEnabled) hazeState else null,
                            isFloating = true,
                            labelMode = bottomBarLabelMode
                        )
                    }
                } else {
                    // è´´åº•å¼åº•æ 
                    FrostedBottomBar(
                        currentItem = currentNavItem,
                        onItemClick = { item ->
                            currentNavItem = item
                            when(item) {
                                BottomNavItem.HOME -> {
                                    coroutineScope.launch { gridState.animateScrollToItem(0) }
                                }
                                BottomNavItem.DYNAMIC -> onDynamicClick()
                                BottomNavItem.HISTORY -> onHistoryClick()
                                BottomNavItem.PROFILE -> onProfileClick()
                            }
                        },
                        onHomeDoubleTap = {
                            coroutineScope.launch { gridState.animateScrollToItem(0) }
                        },
                        hazeState = if (isBottomBarBlurEnabled) hazeState else null,
                        isFloating = false,
                        labelMode = bottomBarLabelMode
                    )
                }
            }
        },
        // ğŸ”Œ [æ–°å¢] JSON æ’ä»¶è¿‡æ»¤æç¤º
        snackbarHost = {
            SnackbarHost(
                hostState = snackbarHostState,
                modifier = Modifier.padding(bottom = if (isBottomBarFloating) 100.dp else 80.dp)
            )
        },
        containerColor = MaterialTheme.colorScheme.background
    ) { padding ->
        Box(
            modifier = Modifier
                .fillMaxSize()
                .haze(state = hazeState)  // ğŸ”¥ Haze æºï¼šæ•´ä¸ªå†…å®¹åŒºåŸŸ
        ) {
            if (state.isLoading && state.videos.isEmpty() && state.liveRooms.isEmpty()) {
                // ğŸ”¥ é¦–æ¬¡åŠ è½½æ”¹ä¸ºéª¨æ¶å±
                LazyVerticalGrid(
                    columns = GridCells.Fixed(gridColumns),
                    contentPadding = PaddingValues(
                        top = 156.dp,
                        bottom = if (isBottomBarFloating) 100.dp else padding.calculateBottomPadding() + 20.dp,
                        start = 8.dp,
                        end = 8.dp
                    ),
                    horizontalArrangement = Arrangement.spacedBy(8.dp),
                    verticalArrangement = Arrangement.spacedBy(8.dp),
                    modifier = Modifier.fillMaxSize()
                ) {
                    items(8) { index ->
                        VideoCardSkeleton(index = index)
                    }
                }
            // ğŸ”¥ğŸ”¥ [ä¿®å¤] æ ¹æ®åˆ†ç±»ç±»å‹åˆ¤æ–­æ˜¯å¦æœ‰å†…å®¹
            } else if (state.error != null && 
                ((state.currentCategory == HomeCategory.LIVE && state.liveRooms.isEmpty()) ||
                 (state.currentCategory != HomeCategory.LIVE && state.videos.isEmpty()))) {
                ModernErrorState(
                    message = state.error ?: "æœªçŸ¥é”™è¯¯",
                    onRetry = { viewModel.refresh() },
                    modifier = Modifier
                        .fillMaxSize()
                        .padding(bottom = if (isBottomBarFloating) 100.dp else padding.calculateBottomPadding() + 20.dp)
                )
            } else {
                // ğŸš€ [æ€§èƒ½ä¼˜åŒ–] ç§»é™¤ AnimatedContent åŒ…è£¹ï¼Œå‡å°‘åˆ†ç±»åˆ‡æ¢æ—¶çš„é‡ç»„å¼€é”€
                // åŸï¼šAnimatedContent å¯¹æ•´ä¸ª Grid åšåŠ¨ç”»ï¼Œæˆæœ¬å¾ˆé«˜
                // æ–°ï¼šç›´æ¥æ¸²æŸ“ï¼Œåˆ†ç±»åˆ‡æ¢ç¬é—´å®Œæˆ
                val targetCategory = state.currentCategory
                
                // ğŸ”¥ ä½¿ç”¨ PullToRefreshBox åŒ…è£¹å†…å®¹
                PullToRefreshBox(
                    isRefreshing = isRefreshing,
                    onRefresh = { viewModel.refresh() },
                    state = pullRefreshState,
                    modifier = Modifier.fillMaxSize(),
                    // ğŸ iOS é£æ ¼ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨
                    indicator = {
                        iOSRefreshIndicator(
                            state = pullRefreshState,
                            isRefreshing = isRefreshing,
                            modifier = Modifier
                                .align(Alignment.TopCenter)
                                .padding(top = 100.dp)  // ğŸ”¥ åˆ·æ–°æç¤ºä½ç½®
                        )
                    }
                ) {
                LazyVerticalGrid(
                    state = gridState,
                    columns = GridCells.Fixed(gridColumns),
                    contentPadding = PaddingValues(
                        top = 156.dp,  // ğŸ”¥ Header é«˜åº¦
                        bottom = if (isBottomBarFloating) 100.dp else padding.calculateBottomPadding() + 20.dp,
                        start = 8.dp, 
                        end = 8.dp
                    ),
                    horizontalArrangement = Arrangement.spacedBy(8.dp),
                    verticalArrangement = Arrangement.spacedBy(8.dp),
                    modifier = Modifier
                        .fillMaxSize()
                        .padding(bottom = if (isBottomBarFloating) 0.dp else navBarHeight)
                        // ğŸ”¥ æ°´å¹³æ»‘åŠ¨æ‰‹åŠ¿åˆ‡æ¢åˆ†ç±»
                        .pointerInput(targetCategory) {
                            var totalDragX = 0f
                            detectHorizontalDragGestures(
                                onDragStart = { totalDragX = 0f },
                                onDragEnd = {
                                    // æ»‘åŠ¨é˜ˆå€¼ï¼š120px
                                    if (totalDragX > 120f) {
                                        // å³æ»‘ï¼šåˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªåˆ†ç±»
                                        switchToPreviousCategory()
                                    } else if (totalDragX < -120f) {
                                        // å·¦æ»‘ï¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªåˆ†ç±»
                                        switchToNextCategory()
                                    }
                                },
                                onDragCancel = { totalDragX = 0f },
                                onHorizontalDrag = { change, dragAmount ->
                                    change.consume()
                                    totalDragX += dragAmount
                                }
                            )
                        }
                ) {
                    if (targetCategory == HomeCategory.LIVE) {
                        item(span = { GridItemSpan(gridColumns) }) {
                            LiveSubCategoryRow(
                                selectedSubCategory = state.liveSubCategory,
                                onSubCategorySelected = { viewModel.switchLiveSubCategory(it) }
                            )
                        }

                        if (state.liveRooms.isNotEmpty()) {
                            itemsIndexed(
                                items = state.liveRooms,
                                key = { _, room -> room.roomid },
                                contentType = { _, _ -> "live_room" }
                            ) { index, room ->
                                LiveRoomCard(
                                    room = room,
                                    index = index,
                                    onClick = { onLiveClick(room.roomid, room.title, room.uname) } 
                                )
                            }
                        }
                    } else {
                        if (state.videos.isNotEmpty()) {
                            itemsIndexed(
                                items = state.videos,
                                key = { _, video -> video.bvid },
                                contentType = { _, _ -> "video" }
                            ) { index, video ->
                                // ğŸ”¥ğŸ”¥ [æ–°å¢] æ ¹æ®å±•ç¤ºæ¨¡å¼é€‰æ‹©å¡ç‰‡æ ·å¼
                                when (displayMode) {
                                    1 -> {
                                        // ğŸ¬ æ•…äº‹å¡ç‰‡ (Apple TV+ é£æ ¼)
                                        StoryVideoCard(
                                            video = video,
                                            index = index,  // ğŸ”¥ åŠ¨ç”»ç´¢å¼•
                                            animationEnabled = cardAnimationEnabled,  // ğŸ”¥ åŠ¨ç”»å¼€å…³
                                            transitionEnabled = cardTransitionEnabled, // ğŸ”¥ è¿‡æ¸¡åŠ¨ç”»å¼€å…³
                                            onClick = { bvid, cid -> wrappedOnVideoClick(bvid, cid, video.pic) }
                                        )
                                    }
                                    2 -> {
                                        // ğŸ ç»ç’ƒæ‹Ÿæ€ (Vision Pro é£æ ¼)
                                        GlassVideoCard(
                                            video = video,
                                            index = index,  // ğŸ”¥ åŠ¨ç”»ç´¢å¼•
                                            animationEnabled = cardAnimationEnabled,  // ğŸ”¥ åŠ¨ç”»å¼€å…³
                                            transitionEnabled = cardTransitionEnabled, // ğŸ”¥ è¿‡æ¸¡åŠ¨ç”»å¼€å…³
                                            onClick = { bvid, cid -> wrappedOnVideoClick(bvid, cid, video.pic) }
                                        )
                                    }
                                    else -> {
                                        // ğŸ”¥ é»˜è®¤ç½‘æ ¼å¡ç‰‡
                                        ElegantVideoCard(
                                            video = video,
                                            index = index,
                                            isFollowing = video.owner.mid in state.followingMids,  // ğŸ”¥ åˆ¤æ–­æ˜¯å¦å·²å…³æ³¨
                                            animationEnabled = cardAnimationEnabled,    // ğŸ”¥ è¿›åœºåŠ¨ç”»å¼€å…³
                                            transitionEnabled = cardTransitionEnabled,  // ğŸ”¥ è¿‡æ¸¡åŠ¨ç”»å¼€å…³
                                            onClick = { bvid, cid -> wrappedOnVideoClick(bvid, cid, video.pic) }
                                        )
                                    }
                                }
                            }
                        }
                    }

                    if (!state.isLoading && state.error == null) {
                        item(span = { GridItemSpan(gridColumns) }) {
                            LaunchedEffect(Unit) {
                                viewModel.loadMore()
                            }
                            Box(
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .padding(16.dp),
                                contentAlignment = Alignment.Center
                            ) {
                                if (state.isLoading) {
                                    CupertinoActivityIndicator(
                                        modifier = Modifier.size(24.dp),
                                        color = MaterialTheme.colorScheme.secondary
                                    )
                                }
                            }
                        }
                    }
                    
                    item(span = { GridItemSpan(gridColumns) }) {
                        Box(modifier = Modifier.fillMaxWidth().height(20.dp))
                    }
                }
                }
            }

            // ğŸ iOS é£æ ¼ Header (å¸¦æ»šåŠ¨éšè—/æ˜¾ç¤ºåŠ¨ç”»)
            // ä½¿ç”¨ zIndex ç¡®ä¿ header å§‹ç»ˆåœ¨åˆ—è¡¨å†…å®¹ä¹‹ä¸Š
            Box(modifier = Modifier.zIndex(1f)) {
                iOSHomeHeader(
                    scrollOffset = scrollOffset,
                    user = state.user,
                    onAvatarClick = { if (state.user.isLogin) onProfileClick() else onAvatarClick() },
                    onSettingsClick = onSettingsClick,
                    onSearchClick = onSearchClick,
                    categoryIndex = displayedTabIndex,  // ğŸ”¥ğŸ”¥ [ä¿®å¤] ä½¿ç”¨ ViewModel ä¸­çš„æ ‡ç­¾é¡µç´¢å¼•
                    onCategorySelected = { index ->
                        // ğŸ”¥ğŸ”¥ [ä¿®å¤] é€šè¿‡ ViewModel æ›´æ–°æ ‡ç­¾é¡µæ˜¾ç¤ºä½ç½®
                        viewModel.updateDisplayedTabIndex(index)
                        val category = HomeCategory.entries[index]
                        // ğŸ”¥ğŸ”¥ åˆ†ç±»è·³è½¬é€»è¾‘
                        when (category) {
                            HomeCategory.ANIME -> onBangumiClick(1)   // ç•ªå‰§
                            HomeCategory.MOVIE -> onBangumiClick(2)   // ç”µå½±
                            // ğŸ”¥ æ–°å¢åˆ†ç±»ï¼šè·³è½¬åˆ°åˆ†ç±»è¯¦æƒ…é¡µé¢
                            HomeCategory.GAME,
                            HomeCategory.KNOWLEDGE,
                            HomeCategory.TECH -> onCategoryClick(category.tid, category.label)
                            // å…¶ä»–åˆ†ç±»æ­£å¸¸åˆ‡æ¢
                            else -> viewModel.switchCategory(category)
                        }
                    },
                    onPartitionClick = onPartitionClick,  // ğŸ”¥ åˆ†åŒºæŒ‰é’®ç‚¹å‡»
                    isScrollingUp = isScrollingUp,
                    hazeState = if (isHeaderBlurEnabled) hazeState else null,  // ğŸ”¥ æ¢å¤ header æ¨¡ç³Š
                    onStatusBarDoubleTap = {
                        // ğŸ åŒå‡»çŠ¶æ€æ ï¼Œå¹³æ»‘æ»šåŠ¨å›é¡¶éƒ¨
                        coroutineScope.launch {
                            gridState.animateScrollToItem(0)
                        }
                    },
                    // ğŸ [æ–°å¢] ä¸‹æ‹‰åˆ·æ–°æ—¶æ”¶èµ·æ ‡ç­¾é¡µ
                    isRefreshing = isRefreshing,
                    pullProgress = pullRefreshState.distanceFraction
                )
            }
        }
    }
}